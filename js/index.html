<html>
    <head>
        <script type="text/javascript">
PREINIT = 'preinit';
INIT = 'init';
AUTH = 'auth';
RUNNING = 'running';

function testfn(msg) {
    console.log("received",msg);
}
function errfn(msg) {
    console.log("error", msg);
}
function okfn(msg) {
    console.log("ok", msg);
}
function freekey_init() {
    freekey = new FreeKey();
    freekey.display();
    rc = $.cookie('freekey-rc');
    if (!rc) rc = 'rc';
    $.get(rc).success(function() {
        $.cookie('freekey-rc', rc, { expires: 360 });
        freekey.setConfig(eval(js));
    }).error(function() {
        freekey.noConfig();
    });
    if (window != window.top) {
        console.log('iframe binding');
        $.postmsg.listen('null', 'test', testfn);
        var w = window.top;
        setTimeout(function() {
            $.postmsg.send(w, '*', 'test', 'Message',
                    {success: okfn, error: errfn});
        }, 200);
    } else {
        console.log('main binding');
        $.postmsg.listen('null', 'test', testfn);
        var w = $('#awesome')[0].contentWindow;
        w.location = 'index.html';
        setTimeout(function() {
            $.postmsg.send(w, '*', 'test', 'Message',
                    {success: okfn, error: errfn});
        }, 200);
    }
}

function FreeKey() {
    this.display = function() {
        $('#freekey').html($('#' + this.state).html());
        return this;
    }
    this.noConfig = function() {
        this.state = INIT;
        return this.display();
    }
    this.setConfig = function(config) {
        if (this.state !== PREINIT) {
            return;
        }
        this.config = config;
        if (!this.config.credentials) {
            this.state = INIT;
        } else {
            this.state = AUTH;
        }
        return this.display();
    }
    this.doConfig = function() {
        conf = $('#init_form');
        alert($('#init_form'));
    }
    this.state = PREINIT;
}

function S3Bucket(bucket, access_key, secret_key) {
    this.bucket = bucket;
    this.access_key = access_key;
    this.secret_key = secret_key;
    this.authString = function(resource, verb, md5, type, amzheaders) {
        parts = [];
        parts.push(verb || 'GET');
        parts.push(md5 || '');
        parts.push(type || '');
        parts.push(new Date().toUTCString());
        amzheaders = amzheaders || {}
        can_amzheaders = {}
        for (key in amzheaders) {
            can_amzheaders[key.toLowerCase()] = amzheaders[key];
        }
        keys = [];
        for (key in can_amzheaders) keys.push(key);
        keys.sort();
        for (key in keys) {
            parts.push(key+':'+can_amzheaders[key]);
        }
        parts.push(resource);
        hm = new sjcl.misc.hmac(this.secret_key, sjcl.hash.sha1);
        code = sjcl.codec.base64.fromBits(hm.encrypt(parts.join('\n')));
        return 'AWS ' + this.access_key + ':' + code;
    }
    this.put = function(key, data) {
        $.ajax('http://' + this.bucket + ".s3.amazonaws.com/" + key, {
            type: 'POST',
            headers: {'Authorization': this.authString('/' + key) },
            error: function(data) {
                console.log("Error");
                console.log(data);
            },
            success: function(data) {
                console.log("Success");
                console.log(data);
            }
        });
    }
    this.set_policy = function(policy) {
        alert("Not implemented");
    }
    this.get = function(key) {
        $.ajax('http://' + this.bucket + ".s3.amazonaws.com/" + key, {
            headers: {'Authorization': this.authString('/' + key) },
                error: function(data) {
                console.log("Error");
                console.log(data);
            },
                success: function(data) {
                console.log("Success");
                console.log(data);
            }
        });
    }
}
        </script>
        <style>
            div.js { display: none; }
            div.init_submit { width: 100%; text-align: center; clear: both;}
            div.init_label { width: 8em; clear: left; float: left; }
            div.init_input { clear: right; float: left; }
        </style>
    </head>
    <body>
        <div id='freekey'>
        </div>
        <div class='js' id='preinit'>
            Loading FreeKey...
        </div>
        <div class='js' id='init'>
            <form id='init_form'>
                <div class='init_label'><label for="s3_bucket">S3 Bucket:</label></div>
                <div class='init_input'><input type="text" id="s3_bucket" value=""/></div>
                <div id='aws_info'>
                    <div class='init_label'><label for="aws_access">AWS Access Key:</label></div>
                    <div class='init_input'><input type="text" id="aws_access" value=""/></div>
                    <div class='init_label'><label for="aws_secret">AWS Secret Key:</label></div>
                    <div class='init_input'><input type="password" id="aws_secret" value=""/></div>
                </div>
                <div class='init_label'><label for="passphrase">Pass phrase:</label></div>
                <div class='init_input'><input type="password" id="passphrase" value=""/></div>
                <div class="init_submit">
                    <input type="submit" id="submit" value="Start FreeKey"
                           onclick="freekey.doConfig(); return false;"/>
                </div>
            </form>
        </div>
        <iframe id='awesome'>No browser iframe support</iframe>
        <script type="text/javascript" src='jquery.js'>
        </script>
        <script type="text/javascript" src='jquery.cookie.js'>
        </script>
        <script type="text/javascript" src='jquery.postmsg.js'>
        </script>
        <script type="text/javascript" src='../../sjcl/sjcl.js'>
        </script>
        <script type='text/javascript'>
$(document).ready(function() { freekey_init(); });
        </script>
    </body>
</html>
